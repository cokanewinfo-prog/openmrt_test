你是一名精通 OpenWrt 23.05、nftables、Xray-core、WireGuard 路由策略以及高级 DNS 的网络工程师。
请基于以下条件，设计并输出一套【工程级、可维护、可扩展】的旁路由分流方案，通过 nftables + Xray-core 协同实现复杂、多条件流量分流，并以“可直接部署”为最终交付目标。

────────────────────────────────
一、最终交付目标（必须严格满足）
────────────────────────────────

你的输出不是示例、不是伪代码、不是思路，而是【可直接复制到 OpenWrt 23.05 部署的工程交付物】。

最终输出必须包含以下四类交付物：

A）完整方案文档  
B）完整可落盘配置文件  
C）一键部署脚本  
D）验证与排障清单  

────────────────────────────────
A）完整方案文档（必须按 1~9 章节顺序输出）
────────────────────────────────

按下文【六、输出顺序】要求，完整输出方案说明。

────────────────────────────────
B）完整可落盘配置文件（必须给出“全量内容”）
────────────────────────────────

必须给出以下文件的完整内容（不是片段、不是省略）：

1. /etc/nftables.d/99-xray-transparent.nft  
   - 只包含你自定义的 nftables 规则  
   - 与 OpenWrt 23.05 默认 nftables 架构兼容  

2. /etc/xray/config.json  
   或【推荐结构】：
   /etc/xray/conf.d/
     ├── 00-inbounds.json
     ├── 10-routing.json
     ├── 20-outbounds.json
     └── 30-dns.json

3. /etc/dnsmasq.d/split.conf  
   - 使用 dnsmasq-full  
   - 支持 ipset / nftset  
   - 不污染 /etc/config/dhcp  

4. 分流数据文件目录结构：
   /root/splittunnel/
     ├── domains/
     ├── ipset/
     ├── README.md

5. geosite / geoip 数据文件获取或放置方式  
   - 支持脚本自动下载或本地加载  

────────────────────────────────
C）一键部署脚本（强制要求）
────────────────────────────────

必须提供一个可直接执行的脚本：

/root/deploy_splittunnel.sh

脚本硬性要求（不满足即视为失败）：

1. BusyBox sh 兼容  
   - 不允许使用 bash 特性  
   - 不使用数组  
   - 不使用 [[ ]]  

2. 禁止 UCI 交互  
   - 不使用 uci prompt  
   - 不向用户询问任何输入  
   - 所有变量必须集中在脚本头部定义  

3. 工程化能力  
   - 幂等：重复执行不会产生重复规则或异常状态  
   - 自检：检测依赖包、内核模块、接口（wg0）、服务状态  
   - 备份：部署前备份相关文件到：
     /root/backup-YYYYmmdd-HHMMSS/
   - 回滚：
     - 失败自动回滚
     - 或支持 --rollback 参数
   - 日志：
     /root/deploy_splittunnel.log

4. 脚本必须自动完成以下动作：
   - 安装缺失软件包（dnsmasq-full、xray-core、kmod-nft-tproxy 等）
   - 写入或覆盖配置文件
   - reload / restart：
     - network
     - firewall
     - dnsmasq
     - xray
   - 部署完成后输出：
     - 验证命令清单
     - 成功 / 失败判定标准

5. 脚本头部必须包含“变量块”，并预填如下网络环境：
   LAN_SUBNET=192.168.88.0/24
   MAIN_ROUTER_IP=192.168.88.1
   SIDECAR_IP=192.168.88.200
   WG_IFACE=wg0

   所有端口、fwmark、路由表号必须集中定义

────────────────────────────────
D）验证与排障清单（必须给出）
────────────────────────────────

- 至少 15 条实际可用命令
- 覆盖以下维度：
  - nftables
  - ip rule / ip route
  - conntrack
  - dnsmasq
  - Xray
  - WireGuard
  - tcpdump
- 每条命令必须说明：
  - 用途
  - 正常现象
  - 异常意味着什么

────────────────────────────────
二、基础环境
────────────────────────────────

- OpenWrt：23.05.3（nftables 防火墙架构）
- 模式：旁路由（非主网关，不开启 DHCP）
- 主路由：
  - IP：192.168.88.1
  - 职责：拨号 / NAT / DHCP
- 旁路由：
  - IP：192.168.88.200
  - 职责：流量识别 / 分流 / 代理出口
- 不修改主路由配置
- DNS：必须使用 dnsmasq-full

────────────────────────────────
三、已知前置条件
────────────────────────────────

- WireGuard 客户端已完成配置
- 接口名称固定为：wg0
- wg0 已连通稳定
- 本方案不设计 WireGuard 建链

────────────────────────────────
四、核心强制要求（必须逐条满足并显式说明）
────────────────────────────────

1. 只使用 Xray-core（禁止 V2Ray）
2. 禁止使用 pbr / passwall / openclash 等插件
3. nftables 只负责判断与透明引流
4. Xray 仅处理被引流流量
5. 中国大陆流量不得进入 Xray
   - 必须在 nftables 层放行直连
6. wg0 作为可选出口
7. DNS 路径与转发路径必须一致，防止污染与泄漏

────────────────────────────────
五、分流能力要求（必须实现）
────────────────────────────────

- 域名：geosite / domain / regexp
- IP：CIDR / GeoIP
- 协议与端口：TCP / UDP
- 客户端：源 IP 或 MAC（至少一种工程可行方案）
- 多出口：直连 / wg0 / 代理节点
- 失败回退与兜底策略

────────────────────────────────
六、推荐技术模型（必须落地）
────────────────────────────────

nftables：
- prerouting 阶段判断
- 非国内流量透明引流（REDIRECT 或 TPROXY，需说明选型理由）
- 国内流量在 L3/L4 层绕过代理

Xray：
- 仅接管被引流流量
- 执行 L7 路由规则
- 根据规则选择 wg0 或代理节点出口

DNS：
- 客户端 DNS 指向旁路由
- 国内域名使用国内 DNS
- 国外域名可被识别与分流
- 必须说明 DNS 防泄漏机制

────────────────────────────────
七、输出顺序（必须严格遵守）
────────────────────────────────

1. 网络拓扑与完整数据流向说明
2. 方案设计理念与分层职责划分
3. nftables 引流与放行逻辑说明
4. Xray-core 核心配置结构说明
5. DNS 配置设计与防泄漏方案
6. 典型分流规则示例
7. 多出口与失败回退实现方式
8. 验证、调试与故障定位方法
9. 可维护性与后期扩展建议

────────────────────────────────
八、工程约束（强制）
────────────────────────────────

- mark / table / chain / set 命名必须规范化
- 所有参数必须集中配置
- 禁止“大陆流量进入 Xray 再直连”
- 必须同时提供：
  - Xray 内 geosite / geoip 分流
  - dnsmasq ipset / nftset 前置分流
- 必须说明性能、conntrack、UDP、MTU、DNS 缓存等风险
- 所有脚本必须通过 `sh -n` 语法校验
- nftables 规则必须可通过 `nft -c -f` 校验
- 若国内流量进入 Xray inbound，即视为失败
- conf.d 结构必须说明 Xray 加载方式，否则退回单文件
- 所有 fallback 必须体现在配置文件而非文字

────────────────────────────────
最终目标
────────────────────────────────

输出一套【可直接在 OpenWrt 23.05 旁路由部署】
【工程级、可维护、可扩展、可回滚】
的完整分流系统交付方案。
